<!DOCTYPE html>
<html>
	<head>
		<title>WRS &ndash; Client AI</title>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
		<style type="text/css">

#status {
	background-color: #EFEFEF;
	border-top: 1px solid black;
	border-right: 1px solid black;
	position: fixed;
	bottom: 0px;
	padding: 0.25em;
	padding-left: 0.5em;
	padding-right: 0.5em;
}

		</style>
	</head>
	<body>
		<div id="status">GUI is loading...</div>
		<canvas id="screen" width="100" height="100"></canvas>
		<script src="//code.jquery.com/jquery.min.js" type="text/javascript"></script>
		<script type="text/javascript">

$(function() {

	/**
	 * Changes the status message
	 */
	var status = function(message) {
		var dom = $('#status');
		dom.text(message);
		dom.show();
		setTimeout(function() {
			dom.fadeOut(1500);
		}, 2500);
	};



	/**
	 * Will load configuration from backend
	 */
	var configuration = function(cb) {
		$.getJSON('/configuration', function(data) {
			cb(data);
		});
	};



	/**
	 * Blocks until the next data is available
	 */
	var listen = function(cb) {
		$.getJSON('/listen', function(data) {
			cb(data);
		});
	};



	/**
	 */
	var render = function(context, configuration, data) {

		/* @see http://stackoverflow.com/a/6333775
		 */
		var arrow = function(x, y, dx, dy) {
			var headlen = 10;
			var tox = x + dx;
			var toy = y + dy;

			var angle = Math.atan2(dy, dx);
			context.moveTo(x, y);
			context.lineTo(tox, toy);
			context.lineTo(tox - headlen*Math.cos(angle-Math.PI/6), toy - headlen*Math.sin(angle-Math.PI/6));
			context.moveTo(tox, toy);
			context.lineTo(tox - headlen*Math.cos(angle+Math.PI/6), toy - headlen*Math.sin(angle+Math.PI/6));
		};


		/* Clear screen
		 */
		context.fillStyle = 'rgb(255, 0, 255)';
		context.fillRect(0, 0, screen.width, screen.height);


		/* Draw all circles
		 */
		for (var i = 0; i < data.circles.length; ++i) {
			var circle = {
				x:	data.circles[i][0],
				y:	data.circles[i][1],
				radius:	data.circles[i][2],
				fill:	data.colors[data.circles[i][3]],
				stroke:	data.colors[data.circles[i][4]]
			};

			context.beginPath();

			if (null != circle.fill) {
				context.fillStyle = circle.fill;
			}
			if (null != circle.stroke) {
				context.strokeStyle = circle.stroke;
			}
			context.lineWidth = 2.0;
			context.arc(
				circle.x + configuration['game-zone'],
				circle.y + configuration['game-zone'],
				circle.radius,
				0, 2 * Math.PI,
				false
			);
			context.closePath();

			if (null !== circle.fill) {
				context.fill();
			}
			if (null !== circle.stroke) {
				context.stroke();
			}
		}


		/* Draw all arrows
		 */
		for (var i = 0; i < data.arrows.length; ++i) {
			var arrow = {
				x:		data.arrows[i][0],
				y:		data.arrows[i][1],
				dx:		data.arrows[i][2],
				dy:		data.arrows[i][3],
				'line-width':	data.arrows[i][4],
				stroke:		data.colors[data.arrows[i][5]]
			};

			context.beginPath();
			context.strokeStyle = arrow.stroke;
			context.lineWidth = arrow['line-width'];
			arrow(
				arrow.x + configuration['game-zone'],
				arrow.y + configuration['game-zone'],
				parseFloat(arrow.dx),
				parseFloat(arrow.dy)
			);
			context.closePath();
			context.stroke();
		}
	};





	/**
	 * Initializing GUI
	 */
	status('Loading configuration...');
	var screen = document.getElementById('screen');

	configuration(function(config) {
		status('Configuration loaded');

		screen.width = config['game-zone'] * 2;
		screen.height = config['game-zone'] * 2;
		var context = screen.getContext('2d');

		var update = function() {
			listen(function(data) {
				render(context, config, data);
				setTimeout(update, 250);
			});
		};

		update();
	});
});

		</script>
	</body>
</html>
